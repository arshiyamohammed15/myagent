<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Agent - Task Management</title>
    <link rel="stylesheet" href="task_display.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Modern Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-tasks"></i>
                <span>Planner Agent</span>
            </div>
            <nav class="nav-controls">
                <button class="btn btn-secondary refresh-btn" onclick="refreshTasks()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="btn btn-primary" onclick="showAllTasks()">
                    <i class="fas fa-list"></i>
                    All Tasks
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="dashboard">
        <div class="dashboard-grid">
            <!-- Tasks Overview Sidebar -->
            <aside class="tasks-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-clipboard-list"></i> Task Overview</h3>
                    <button class="btn btn-success btn-sm" onclick="generateNewTask()" title="Generate new test plan (Ctrl+N)">
                        <i class="fas fa-plus"></i>
                        New Task
                    </button>
                </div>
                <div class="tasks-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-tasks">0</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number pending" id="pending-tasks">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number in-progress" id="in-progress-tasks">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number completed" id="completed-tasks">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>
                <div class="recent-tasks">
                    <h4>Recent Tasks</h4>
                    <div id="recent-tasks-list" class="task-list">
                        <div class="loading">Loading tasks...</div>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Task Details Panel -->
                <div class="content-panel task-details-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-info-circle"></i> Task Details</h2>
                        <div class="panel-actions">
                            <button class="btn btn-outline" onclick="editTask()">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                            <button class="btn btn-outline" onclick="duplicateTask()">
                                <i class="fas fa-copy"></i>
                                Duplicate
                            </button>
                        </div>
                    </div>
                    <div id="task-details-container" class="panel-content">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            Loading task details...
                        </div>
                    </div>
                </div>

                <!-- Comments Panel -->
                <div class="content-panel comments-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-comments"></i> Comments</h2>
                        <span class="comments-count" id="comments-count">0 comments</span>
                    </div>
                    <div class="panel-content">
                        <div id="comments-container">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading comments...
                            </div>
                        </div>

                        <!-- Add Comment Form -->
                        <div class="comment-form">
                            <div class="form-group">
                                <label for="comment-input">Add a comment:</label>
                                <textarea
                                    id="comment-input"
                                    class="form-control"
                                    placeholder="Write your comment here... Use @username to mention someone"
                                    maxlength="1000"
                                    rows="3"></textarea>
                                <div class="form-footer">
                                    <div class="char-count">
                                        <span id="char-count">0</span>/1000
                                    </div>
                                    <button class="btn btn-primary" onclick="postComment()" id="post-btn">
                                        <i class="fas fa-paper-plane"></i>
                                        Post Comment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Action Button -->
    <button class="fab" onclick="generateNewTask()" title="Create New Task">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Modal for New Task Generation -->
    <div id="new-task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus"></i> Generate New Test Plan</h2>
                <button class="modal-close" onclick="closeNewTaskModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="new-task-form" class="form">
                    <div class="form-group">
                        <label for="goal-input">Testing Goal *</label>
                        <input
                            type="text"
                            id="goal-input"
                            class="form-control"
                            placeholder="e.g., Implement user authentication system"
                            required
                        />
                        <small class="form-help">Primary testing objective or goal</small>
                    </div>

                    <div class="form-group">
                        <label for="feature-input">Feature Under Test *</label>
                        <input
                            type="text"
                            id="feature-input"
                            class="form-control"
                            placeholder="e.g., Login and registration"
                            required
                        />
                        <small class="form-help">Specific feature or functionality to test</small>
                    </div>

                    <div class="form-group">
                        <label for="constraints-input">Constraints (Optional)</label>
                        <textarea
                            id="constraints-input"
                            class="form-control"
                            placeholder="• Use JWT tokens&#10;• Support email/password&#10;• Mobile responsive"
                            rows="3"
                        ></textarea>
                        <small class="form-help">One constraint per line, starting with bullet points</small>
                    </div>

                    <div class="form-group">
                        <label for="template-select">Template</label>
                        <select id="template-select" class="form-control">
                            <option value="basic">Basic (Recommended)</option>
                            <option value="complex">Complex</option>
                            <option value="minimal">Minimal</option>
                            <option value="full_coverage">Full Coverage</option>
                        </select>
                        <small class="form-help">Choose the testing template to use</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeNewTaskModal()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="generateNewPlan()" id="generate-btn">
                    <i class="fas fa-cog"></i>
                    Generate Plan
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Generated Plan Results -->
    <div id="plan-results-modal" class="modal">
        <div class="modal-content plan-results-modal">
            <div class="modal-header">
                <h2><i class="fas fa-check-circle"></i> Test Plan Generated Successfully!</h2>
                <button class="modal-close" onclick="closePlanResultsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="plan-summary" class="plan-summary">
                    <!-- Plan summary will be populated here -->
                </div>
                <div class="generated-tasks-section">
                    <h3><i class="fas fa-tasks"></i> Generated Tasks</h3>
                    <div id="generated-tasks-list" class="generated-tasks-list">
                        <!-- Generated tasks will be displayed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closePlanResultsModal()">
                    <i class="fas fa-times"></i>
                    Close
                </button>
                <button type="button" class="btn btn-primary" onclick="viewFirstTask()">
                    <i class="fas fa-eye"></i>
                    View First Task
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <script>
        // Configuration
        window.API_BASE_URL = 'http://localhost:8000';
        window.CURRENT_USER = 'john.doe'; // Set from your authentication system
        window.API_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhcGktdXNlciIsImlhdCI6MTc2OTE2ODE4OCwiZXhwIjoxNzY5MTcxNzg4fQ.8YXDUuLlHozmUZMtPVtGNrTNJKeiUqOLN-WCUPYf9kc'; // JWT authentication token
        window.AUTO_REFRESH_COMMENTS = false; // Set to true for auto-refresh

        // Set task ID (can be from URL parameter or set directly)
        document.body.setAttribute('data-task-id', new URLSearchParams(window.location.search).get('task_id') || 'plan-d5e07d18-task-1');

        // Get common headers for API requests
        function getApiHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${window.API_TOKEN}`,
            };
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
    </script>
    <script src="task_page.js"></script>

    <script>
        // Update comments count when comments are loaded
        const originalRenderComments = window.renderComments;
        if (originalRenderComments) {
            window.renderComments = function(comments, containerId, currentUser) {
                originalRenderComments(comments, containerId, currentUser);
                const countElement = document.getElementById('comments-count');
                if (countElement) {
                    countElement.textContent = `${comments.length} comment${comments.length !== 1 ? 's' : ''}`;
                }
            };
        }

        // Character counter for comment input
        document.getElementById('comment-input').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('char-count').textContent = count;
            document.getElementById('post-btn').disabled = count === 0;
        });

        // Initialize app functions
        function initializeApp() {
            loadTaskOverview();
            loadCurrentTask();
        }

        function refreshTasks() {
            showToast('Refreshing tasks...', 'info');
            loadTaskOverview();
            loadCurrentTask();
        }

        function showAllTasks() {
            // Navigate to all tasks view (could be a separate page)
            showToast('All Tasks view coming soon!', 'info');
        }

        function generateNewTask() {
            openNewTaskModal();
        }

        function openNewTaskModal() {
            document.getElementById('new-task-modal').classList.add('show');
            document.getElementById('goal-input').focus();
        }

        function closeNewTaskModal() {
            document.getElementById('new-task-modal').classList.remove('show');
            document.getElementById('new-task-form').reset();
        }

        async function generateNewPlan() {
            const goal = document.getElementById('goal-input').value.trim();
            const feature = document.getElementById('feature-input').value.trim();
            const constraintsText = document.getElementById('constraints-input').value.trim();
            const template = document.getElementById('template-select').value;

            if (!goal || !feature) {
                showToast('Please fill in both Goal and Feature fields', 'error');
                return;
            }

            // Parse constraints (one per line, remove bullet points)
            const constraints = constraintsText
                ? constraintsText.split('\n')
                    .map(line => line.replace(/^[•\-\*]\s*/, '').trim())
                    .filter(line => line.length > 0)
                : null;

            // Show loading state
            const generateBtn = document.getElementById('generate-btn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            generateBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/plan`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        goal: goal,
                        feature: feature,
                        constraints: constraints,
                        template_name: template,
                        save_to_database: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to generate plan: ${response.statusText}`);
                }

                const result = await response.json();

                // Close generation modal
                closeNewTaskModal();

                // Show detailed plan results
                showPlanResults(result);

                // Refresh the task overview to show new tasks
                setTimeout(() => {
                    loadTaskOverview();
                }, 1000);

            } catch (error) {
                console.error('Error generating plan:', error);
                showToast('Failed to generate test plan. Please try again.', 'error');
            } finally {
                // Reset button state
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        function showPlanResults(planResult) {
            // Populate plan summary
            const summaryHtml = `
                <h3><i class="fas fa-rocket"></i> Plan Generated!</h3>
                <p><strong>${planResult.tasks.length}</strong> tasks created for <strong>"${planResult.feature}"</strong></p>
                <p>Goal: ${planResult.goal}</p>
            `;
            document.getElementById('plan-summary').innerHTML = summaryHtml;

            // Populate generated tasks list
            const tasksHtml = planResult.tasks.map((task, index) => {
                const taskNumber = planResult.plan_id.split('-').pop() + '-' + (index + 1).toString().padStart(3, '0');
                const typeClass = task.test_type.toLowerCase();

                return `
                    <div class="generated-task-item">
                        <div class="task-item-header">
                            <span class="task-item-id">${taskNumber}</span>
                            <span class="task-item-type ${typeClass}">
                                <i class="fas fa-${getTypeIcon(task.test_type)}"></i>
                                ${task.test_type}
                            </span>
                        </div>
                        <div class="task-item-description">
                            ${task.description}
                        </div>
                        <div class="task-item-meta">
                            <span><i class="fas fa-clock"></i> Status: ${task.status}</span>
                            <span><i class="fas fa-user"></i> Owner: ${task.owner || 'Unassigned'}</span>
                        </div>
                        <div class="task-item-action">
                            <button class="btn btn-outline btn-sm" onclick="viewTask('${task.id}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('generated-tasks-list').innerHTML = tasksHtml;

            // Store the plan result for later use
            window.lastGeneratedPlan = planResult;

            // Show the modal
            document.getElementById('plan-results-modal').classList.add('show');
        }

        function closePlanResultsModal() {
            document.getElementById('plan-results-modal').classList.remove('show');
        }

        function viewFirstTask() {
            if (window.lastGeneratedPlan && window.lastGeneratedPlan.tasks.length > 0) {
                const firstTaskId = window.lastGeneratedPlan.tasks[0].id;
                loadTask(firstTaskId);
                closePlanResultsModal();
            }
        }

        function viewTask(taskId) {
            loadTask(taskId);
            closePlanResultsModal();
        }

        function getTypeIcon(testType) {
            const icons = {
                'unit': 'code',
                'integration': 'link',
                'e2e': 'route',
                'security': 'shield-alt',
                'performance': 'tachometer-alt',
                'exploratory': 'search'
            };
            return icons[testType.toLowerCase()] || 'tasks';
        }

        // Close modals when clicking outside
        document.getElementById('new-task-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeNewTaskModal();
            }
        });

        document.getElementById('plan-results-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePlanResultsModal();
            }
        });

        // Handle form submission
        document.getElementById('new-task-form').addEventListener('submit', function(e) {
            e.preventDefault();
            generateNewPlan();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // ESC to close modals
            if (e.key === 'Escape') {
                if (document.getElementById('plan-results-modal').classList.contains('show')) {
                    closePlanResultsModal();
                } else if (document.getElementById('new-task-modal').classList.contains('show')) {
                    closeNewTaskModal();
                }
            }

            // Ctrl/Cmd + N to open new task modal
            if ((e.ctrlKey || e.metaKey) && e.key === 'n' && !e.shiftKey) {
                e.preventDefault();
                openNewTaskModal();
            }
        });

        // Real-time form validation
        document.getElementById('goal-input').addEventListener('input', validateForm);
        document.getElementById('feature-input').addEventListener('input', validateForm);

        function validateForm() {
            const goal = document.getElementById('goal-input').value.trim();
            const feature = document.getElementById('feature-input').value.trim();
            const generateBtn = document.getElementById('generate-btn');

            generateBtn.disabled = !goal || !feature;
        }

        function editTask() {
            showToast('Edit task feature coming soon!', 'info');
        }

        function duplicateTask() {
            showToast('Duplicate task feature coming soon!', 'info');
        }

        function postComment() {
            const commentText = document.getElementById('comment-input').value.trim();
            if (!commentText) return;

            showToast('Posting comment...', 'info');

            // Here you would make an API call to post the comment
            setTimeout(() => {
                document.getElementById('comment-input').value = '';
                document.getElementById('char-count').textContent = '0';
                document.getElementById('post-btn').disabled = true;
                showToast('Comment posted successfully!', 'success');
                loadComments(); // Reload comments
            }, 1000);
        }

        async function loadTaskOverview() {
            try {
                // Fetch all tasks from the API
                const response = await fetch(`${API_BASE_URL}/tasks`, {
                    method: 'GET',
                    headers: getApiHeaders(),
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch tasks: ${response.statusText}`);
                }

                const tasks = await response.json();

                // Update stats
                const totalTasks = tasks.length;
                const pendingTasks = tasks.filter(t => t.status === 'pending').length;
                const inProgressTasks = tasks.filter(t => t.status === 'in_progress').length;
                const completedTasks = tasks.filter(t => t.status === 'done' || t.status === 'completed').length;

                document.getElementById('total-tasks').textContent = totalTasks;
                document.getElementById('pending-tasks').textContent = pendingTasks;
                document.getElementById('in-progress-tasks').textContent = inProgressTasks;
                document.getElementById('completed-tasks').textContent = completedTasks;

                // Show recent tasks (last 5)
                const recentTasks = tasks.slice(-5).reverse();
                const recentTasksHtml = recentTasks.map(task => `
                    <div class="task-item" onclick="loadTask('${task.id}')">
                        <div class="task-item-header">
                            <span class="task-id">${task.id.split('-').pop().toUpperCase()}</span>
                            <span class="task-status status-${task.status.toLowerCase().replace('_', '-')}">${task.status.replace('_', ' ')}</span>
                        </div>
                        <div class="task-item-title">${task.description.substring(0, 60)}${task.description.length > 60 ? '...' : ''}</div>
                        <div class="task-item-meta">Type: ${task.test_type} | Owner: ${task.owner || 'Unassigned'}</div>
                    </div>
                `).join('');

                document.getElementById('recent-tasks-list').innerHTML = recentTasksHtml || '<div class="no-tasks">No tasks found</div>';

            } catch (error) {
                console.error('Error loading task overview:', error);
                // Fallback to basic stats
                document.getElementById('total-tasks').textContent = '0';
                document.getElementById('pending-tasks').textContent = '0';
                document.getElementById('in-progress-tasks').textContent = '0';
                document.getElementById('completed-tasks').textContent = '0';
                document.getElementById('recent-tasks-list').innerHTML = '<div class="error">Failed to load tasks</div>';
            }
        }

        function loadCurrentTask() {
            // This will be handled by the existing task_page.js
        }

        function loadComments() {
            // This will be handled by the existing task_page.js
        }

        function loadTask(taskId) {
            window.location.href = `?task_id=${taskId}`;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">×</button>
            `;

            document.getElementById('toast-container').appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>

